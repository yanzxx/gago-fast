<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vip.xiaonuo.biz.modular.supervision.mapper.BizSupervisionMapper">

    <sql id="LivestockScopeWhere">
        where l.delete_flag = 'NOT_DELETE'
        <choose>
            <when test="param != null and param.farmId != null and param.farmId != ''">
                and l.farm_id = #{param.farmId}
            </when>
            <when test="!allFarm">
                <choose>
                    <when test="farmIds != null and farmIds.size() &gt; 0">
                        and l.farm_id in
                        <foreach collection="farmIds" item="farmId" open="(" separator="," close=")">
                            #{farmId}
                        </foreach>
                    </when>
                    <otherwise>
                        and 1 = 0
                    </otherwise>
                </choose>
            </when>
        </choose>
    </sql>

    <sql id="LoanScopeWhere">
        where la.delete_flag = 'NOT_DELETE'
        <choose>
            <when test="param != null and param.farmId != null and param.farmId != ''">
                and la.farm_id = #{param.farmId}
            </when>
            <when test="!allFarm">
                <choose>
                    <when test="farmIds != null and farmIds.size() &gt; 0">
                        and la.farm_id in
                        <foreach collection="farmIds" item="farmId" open="(" separator="," close=")">
                            #{farmId}
                        </foreach>
                    </when>
                    <otherwise>
                        and 1 = 0
                    </otherwise>
                </choose>
            </when>
        </choose>
    </sql>

    <sql id="InsScopeWhere">
        where ia.delete_flag = 'NOT_DELETE'
        <choose>
            <when test="param != null and param.farmId != null and param.farmId != ''">
                and ia.farm_id = #{param.farmId}
            </when>
            <when test="!allFarm">
                <choose>
                    <when test="farmIds != null and farmIds.size() &gt; 0">
                        and ia.farm_id in
                        <foreach collection="farmIds" item="farmId" open="(" separator="," close=")">
                            #{farmId}
                        </foreach>
                    </when>
                    <otherwise>
                        and 1 = 0
                    </otherwise>
                </choose>
            </when>
        </choose>
    </sql>

    <sql id="ClaimScopeWhere">
        where cm.delete_flag = 'NOT_DELETE'
        <choose>
            <when test="param != null and param.farmId != null and param.farmId != ''">
                and cm.farm_id = #{param.farmId}
            </when>
            <when test="!allFarm">
                <choose>
                    <when test="farmIds != null and farmIds.size() &gt; 0">
                        and cm.farm_id in
                        <foreach collection="farmIds" item="farmId" open="(" separator="," close=")">
                            #{farmId}
                        </foreach>
                    </when>
                    <otherwise>
                        and 1 = 0
                    </otherwise>
                </choose>
            </when>
        </choose>
    </sql>

    <sql id="AnomalyScopeWhere">
        where a.delete_flag = 'NOT_DELETE'
        <choose>
            <when test="param != null and param.farmId != null and param.farmId != ''">
                and a.farm_id = #{param.farmId}
            </when>
            <when test="!allFarm">
                <choose>
                    <when test="farmIds != null and farmIds.size() &gt; 0">
                        and a.farm_id in
                        <foreach collection="farmIds" item="farmId" open="(" separator="," close=")">
                            #{farmId}
                        </foreach>
                    </when>
                    <otherwise>
                        and 1 = 0
                    </otherwise>
                </choose>
            </when>
        </choose>
    </sql>

    <sql id="NoticeScopeWhere">
        where n.delete_flag = 'NOT_DELETE'
        <choose>
            <when test="param != null and param.farmId != null and param.farmId != ''">
                and n.farm_id = #{param.farmId}
            </when>
            <when test="!allFarm">
                <choose>
                    <when test="farmIds != null and farmIds.size() &gt; 0">
                        and n.farm_id in
                        <foreach collection="farmIds" item="farmId" open="(" separator="," close=")">
                            #{farmId}
                        </foreach>
                    </when>
                    <otherwise>
                        and 1 = 0
                    </otherwise>
                </choose>
            </when>
        </choose>
    </sql>

    <select id="overview" resultType="vip.xiaonuo.biz.modular.supervision.result.BizSupervisionOverviewResult">
        select
            cast((
                select count(distinct l.farm_id)
                from yzx.biz_livestock l
                <include refid="LivestockScopeWhere"/>
            ) as bigint) as farmCount,
            cast((
                select coalesce(sum(case when l.status = 'IN_STOCK' then 1 else 0 end), 0)
                from yzx.biz_livestock l
                <include refid="LivestockScopeWhere"/>
            ) as bigint) as inStockCount,
            cast((
                select coalesce(sum(case when l.status = 'OUT_STOCK' then 1 else 0 end), 0)
                from yzx.biz_livestock l
                <include refid="LivestockScopeWhere"/>
            ) as bigint) as outStockCount,
            cast((
                select coalesce(sum(case when l.status = 'DEAD' then 1 else 0 end), 0)
                from yzx.biz_livestock l
                <include refid="LivestockScopeWhere"/>
            ) as bigint) as deadCount,
            cast((
                select coalesce(sum(case when l.immunity_status = 'IMMUNIZED' then 1 else 0 end), 0)
                from yzx.biz_livestock l
                <include refid="LivestockScopeWhere"/>
            ) as bigint) as immunizedCount,
            cast((
                select coalesce(sum(case when l.immunity_status = 'NOT_IMMUNIZED' then 1 else 0 end), 0)
                from yzx.biz_livestock l
                <include refid="LivestockScopeWhere"/>
            ) as bigint) as notImmunizedCount,
            cast((
                select coalesce(sum(case when l.immunity_status = 'EXPIRED' then 1 else 0 end), 0)
                from yzx.biz_livestock l
                <include refid="LivestockScopeWhere"/>
            ) as bigint) as expiredCount,
            coalesce((
                select sum(la.apply_amount)
                from yzx.biz_loan_apply la
                <include refid="LoanScopeWhere"/>
                and la.loan_status in ('PROCESSING', 'APPROVED')
            ), 0) as loanAmount,
            coalesce((
                select sum(ia.insured_amount)
                from yzx.biz_ins_apply ia
                <include refid="InsScopeWhere"/>
                and ia.status in ('SUBMITTED', 'POLICY_ISSUED')
            ), 0) as insuredAmount,
            cast((
                select count(1)
                from yzx.biz_claim_manage cm
                <include refid="ClaimScopeWhere"/>
            ) as bigint) as claimTotal,
            cast((
                select coalesce(sum(case when cm.status = 'CLOSED' then 1 else 0 end), 0)
                from yzx.biz_claim_manage cm
                <include refid="ClaimScopeWhere"/>
            ) as bigint) as claimClosed,
            cast((
                select count(1)
                from yzx.biz_after_loan_anomaly a
                <include refid="AnomalyScopeWhere"/>
            ) as bigint) as anomalyTotal,
            cast((
                select coalesce(sum(case when a.status = '处理中' then 1 else 0 end), 0)
                from yzx.biz_after_loan_anomaly a
                <include refid="AnomalyScopeWhere"/>
            ) as bigint) as anomalyProcessing,
            cast((
                select coalesce(sum(case when a.status = '已处置' then 1 else 0 end), 0)
                from yzx.biz_after_loan_anomaly a
                <include refid="AnomalyScopeWhere"/>
            ) as bigint) as anomalyFinished,
            cast((
                select count(1)
                from yzx.biz_after_loan_notice n
                <include refid="NoticeScopeWhere"/>
            ) as bigint) as sentNoticeCount,
            cast((
                select coalesce(sum(case when a.status != '已处置' and a.trigger_time &lt; now() - interval '3 day' then 1 else 0 end), 0)
                from yzx.biz_after_loan_anomaly a
                <include refid="AnomalyScopeWhere"/>
            ) as bigint) as overdueAnomalyCount,
            cast((
                select coalesce(sum(case when a.status = '已处置' and a.update_time is not null and a.update_time &lt;= a.trigger_time + interval '3 day' then 1 else 0 end), 0)
                from yzx.biz_after_loan_anomaly a
                <include refid="AnomalyScopeWhere"/>
            ) as bigint) as resolvedInThreeDaysCount
    </select>

    <select id="mapPoints" resultType="vip.xiaonuo.biz.modular.supervision.result.BizSupervisionMapPointResult">
        with farm_risk as (
            select
                a.farm_id,
                max(case a.risk_level
                        when 'HIGH' then 3
                        when 'MEDIUM' then 2
                        when 'LOW' then 1
                        else 0 end) as risk_rank
            from yzx.biz_after_loan_anomaly a
            <include refid="AnomalyScopeWhere"/>
            group by a.farm_id
        )
        select
            l.farm_id as farmId,
            coalesce(o.name, l.farm_id) as farmName,
            o.ext_json as extJson,
            cast(coalesce(sum(case when l.status = 'IN_STOCK' then 1 else 0 end), 0) as bigint) as inStockCount,
            cast(
                round(
                        (
                            (cast(coalesce(sum(case when l.immunity_status = 'IMMUNIZED' then 1 else 0 end), 0) as numeric))
                                / nullif(cast(count(1) as numeric), 0)
                            * 100
                        ), 0
                ) as int
            ) as healthScore,
            case fr.risk_rank
                when 3 then 'danger'
                when 2 then 'warning'
                else 'normal'
                end as riskLevel
        from yzx.biz_livestock l
                 left join farm_risk fr on fr.farm_id = l.farm_id
                 left join sys_org o on o.id = l.farm_id and o.delete_flag = 'NOT_DELETE'
        <include refid="LivestockScopeWhere"/>
        group by l.farm_id, fr.risk_rank, o.name, o.ext_json
        order by coalesce(sum(case when l.status = 'IN_STOCK' then 1 else 0 end), 0) desc, l.farm_id
        limit 50
    </select>

    <select id="alerts" resultType="vip.xiaonuo.biz.modular.supervision.result.BizSupervisionAlertResult">
        select
            a.id as id,
            a.farm_id as farmId,
            a.risk_level as riskLevel,
            to_char(a.trigger_time, 'HH24:MI') as triggerTime,
            concat(a.anomaly_type, '：', coalesce(a.description, a.target_no)) as content
        from yzx.biz_after_loan_anomaly a
        <include refid="AnomalyScopeWhere"/>
        order by a.trigger_time desc
        limit 5
    </select>

    <select id="anomalies" resultType="vip.xiaonuo.biz.modular.supervision.result.BizSupervisionAnomalyResult">
        select
            a.id as id,
            a.farm_id as farmId,
            a.anomaly_type as anomalyType,
            a.risk_level as riskLevel,
            to_char(a.trigger_time, 'YYYY-MM-DD HH24:MI:SS') as triggerTime,
            a.status as status,
            case when n.id is null then '未发送' else '已发送' end as noticeStatus
        from yzx.biz_after_loan_anomaly a
                 left join yzx.biz_after_loan_notice n on n.anomaly_id = a.id and n.delete_flag = 'NOT_DELETE'
        <include refid="AnomalyScopeWhere"/>
        order by a.trigger_time desc
        limit 10
    </select>

    <select id="farmStats" resultType="vip.xiaonuo.biz.modular.supervision.result.BizSupervisionFarmStatsResult">
        with livestock_stats as (
            select
                cast(coalesce(sum(case when l.status = 'IN_STOCK' then 1 else 0 end), 0) as bigint) as in_stock_count,
                cast(coalesce(sum(case when l.status = 'OUT_STOCK' then 1 else 0 end), 0) as bigint) as out_stock_count,
                cast(coalesce(sum(case when l.status = 'DEAD' then 1 else 0 end), 0) as bigint) as dead_count,
                cast(coalesce(sum(case when l.immunity_status = 'IMMUNIZED' then 1 else 0 end), 0) as bigint) as immunized_count,
                cast(coalesce(sum(case when l.immunity_status = 'NOT_IMMUNIZED' then 1 else 0 end), 0) as bigint) as not_immunized_count,
                cast(coalesce(sum(case when l.immunity_status = 'EXPIRED' then 1 else 0 end), 0) as bigint) as expired_count
            from yzx.biz_livestock l
            where l.delete_flag = 'NOT_DELETE'
              and l.farm_id = #{farmId}
        ),
        loan_stats as (
            select
                cast(count(1) as bigint) as loan_apply_count,
                cast(coalesce(sum(case when la.loan_status = 'APPROVED' then 1 else 0 end), 0) as bigint) as loan_approved_count,
                cast(coalesce(sum(case when la.loan_status = 'PROCESSING' then 1 else 0 end), 0) as bigint) as loan_processing_count,
                cast(coalesce(sum(case when la.loan_status = 'PENDING_SUBMIT' then 1 else 0 end), 0) as bigint) as loan_pending_count,
                coalesce(sum(la.apply_amount), 0) as loan_amount_total,
                coalesce(sum(case when la.loan_status = 'APPROVED' then la.apply_amount else 0 end), 0) as loan_amount_approved
            from yzx.biz_loan_apply la
            where la.delete_flag = 'NOT_DELETE'
              and la.farm_id = #{farmId}
        )
        select
            o.id as farmId,
            o.name as farmName,
            ls.in_stock_count as inStockCount,
            ls.out_stock_count as outStockCount,
            ls.dead_count as deadCount,
            ls.immunized_count as immunizedCount,
            ls.not_immunized_count as notImmunizedCount,
            ls.expired_count as expiredCount,
            los.loan_apply_count as loanApplyCount,
            los.loan_approved_count as loanApprovedCount,
            los.loan_processing_count as loanProcessingCount,
            los.loan_pending_count as loanPendingCount,
            los.loan_amount_total as loanAmountTotal,
            los.loan_amount_approved as loanAmountApproved
        from sys_org o
                 cross join livestock_stats ls
                 cross join loan_stats los
        where o.id = #{farmId}
        limit 1
    </select>
</mapper>

# Gago-Fast 部署文档

## 1. 部署架构

- 后端：`snowy-web-app`，Java 11，默认服务端口 `82`（开发脚本映射为 `8082`）
- 前端：`snowy-web`，Vite 构建产物 `dist/`，Nginx 托管
- 数据库：PostgreSQL（当前项目使用 schema `yzx`）
- 缓存：Redis（登录态、验证码、Sa-Token 依赖）

## 2. 环境要求

- JDK `11`
- Maven `3.8+`
- Node.js `18+`、npm
- PostgreSQL（可连通）
- Redis（可连通）

## 3. 关键配置

后端主配置在：
- `snowy-web-app/src/main/resources/application.properties`
- `snowy-web-app/src/main/resources/application-prod.properties`

核心参数：
- 数据库：`spring.datasource.dynamic.datasource.master.*`
- Redis：`spring.redis.*`
- 服务端口：`server.port`

建议：生产环境不要在 `application-prod.properties` 明文保存密码，改为环境变量或密钥服务注入。

## 4. 本机/测试环境快速部署（推荐）

项目已提供脚本：
- 启动：`scripts/dev_up.sh`
- 停止：`scripts/dev_down.sh`
- 状态检查：`scripts/dev_status.sh`

### 4.1 启动后端（不启动前端）

```bash
cd /Users/yanzx/考核/gago-fast
./scripts/dev_down.sh

PG_HOST="你的数据库域名或IP" \
PG_PORT="1921" \
PG_DB_NAME="liudayu_ks" \
PG_USER="liudayu_ks" \
PG_PASSWORD="你的密码" \
PG_SCHEMA="yzx" \
PG_REMOTE_CHECK_STRICT=true \
START_FRONTEND=false \
./scripts/dev_up.sh
```

### 4.2 启动前端（开发模式）

```bash
cd /Users/yanzx/考核/gago-fast/snowy-web
npm i
npm run dev
```

## 5. 生产手工部署（前后端分离）

## 5.1 后端打包与启动

```bash
cd /Users/yanzx/考核/gago-fast
mvn -s settings.xml -Dmaven.repo.local=.m2/repository -DskipTests package
```

产物：
- `snowy-web-app/target/snowy-web-app-2.0.0.jar`

启动示例：

```bash
java -Xmx2G -Xms1G -jar snowy-web-app/target/snowy-web-app-2.0.0.jar \
  --server.port=82 \
  --spring.datasource.dynamic.datasource.master.driver-class-name=com.p6spy.engine.spy.P6SpyDriver \
  --spring.datasource.dynamic.datasource.master.url='jdbc:p6spy:postgresql://<host>:<port>/<db>?currentSchema=yzx&useUnicode=true&characterEncoding=utf-8&useSSL=false&allowPublicKeyRetrieval=true&nullCatalogMeansCurrent=true&useInformationSchema=true' \
  --spring.datasource.dynamic.datasource.master.username='<user>' \
  --spring.datasource.dynamic.datasource.master.password='<password>' \
  --spring.redis.host='<redis_host>' \
  --spring.redis.port='<redis_port>' \
  --spring.redis.password='<redis_password>'
```

## 5.2 前端打包与Nginx发布

```bash
cd /Users/yanzx/考核/gago-fast/snowy-web
npm i
npm run build
```

产物：
- `snowy-web/dist/`

Nginx 关键规则（示例来自 `docker/nginx/default.conf`）：
- 静态资源：`root /data/web/build;`
- 前端路由：`try_files $uri /index.html;`
- 后端代理：`/api/ -> http://127.0.0.1:82/`

## 6. Docker 部署

### 6.1 单容器（Nginx + 后端）

使用项目根目录 `Dockerfile`：

```bash
cd /Users/yanzx/考核/gago-fast
# 先确保前端 dist、后端 jar 已构建
docker build -t gago-fast:latest -f Dockerfile .
docker run -d --name gago-fast -p 80:80 -p 82:82 gago-fast:latest
```

### 6.2 前后端分容器

- 后端镜像：`server.Dockerfile`
- 前端镜像：`web.Dockerfile`

## 7. Kubernetes 部署

项目示例清单：
- 后端：`deploy/deploy.yaml`、`deploy/deploy-svc.yaml`
- 前端：`deploy-web/devloy.yaml`、`deploy-web/devloy-svc.yaml`

按环境替换镜像地址、端口、资源限制后执行：

```bash
kubectl apply -f deploy/
kubectl apply -f deploy-web/
```

## 8. 验收清单

- 后端端口监听：`lsof -iTCP:82 -sTCP:LISTEN -n -P`（或 `8082`）
- 健康检查：`curl -i http://127.0.0.1:82/actuator/health`
- 登录验证码接口：`curl -i http://127.0.0.1:82/auth/b/getPicCaptcha`
- 前端首页可访问，`/api` 请求无 `503`

## 9. 常见故障与处理

### 9.1 前端全部 `503`

原因：后端未启动或启动失败。

排查：
- `lsof -iTCP:8082 -sTCP:LISTEN -n -P`
- `tail -n 100 .dev/logs/backend.log`

### 9.2 数据库域名解析失败（`UnknownHostException`）

现象：后端日志出现数据库域名无法解析，进程退出。

处理：
- 检查 DNS / 网络
- 必要时在本机加 hosts 映射后刷新 DNS
- 再执行 `./scripts/dev_up.sh`

### 9.3 Redis超时导致登录/验证码异常

现象：日志出现 `RedisCommandTimeoutException`。

处理：
- 确认 Redis 地址、端口、密码
- 检查网络连通和 Redis 负载
- 重点关注 `spring.redis.*` 配置

